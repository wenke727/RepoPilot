# Claude 驱动与平台编排对齐方案（v1）

## 1. 背景与问题定义

当前项目在宣传口径上强调“Claude 驱动开发”，但实际落地偏向“平台编排固定流水线 + Claude 执行某些步骤”。这种差异会导致：

- 预期错位：用户以为 Claude 可以自主决定 Git 策略、节奏与恢复策略。
- 产品边界模糊：出了问题难以判断是“模型决策失误”还是“编排策略限制”。
- 演进受阻：团队在讨论“该让 Claude 做什么”时缺少统一语言。

目标是建立一个分层清晰、可灰度演进、可回滚的对齐方案：

- 保留平台安全兜底与可观测性。
- 让 Claude 在策略层拥有明确且可控的自治空间。
- 让文档、实现、UI 口径保持一致。

## 2. 目标状态：三层职责模型

将“Claude 驱动”拆成三层，避免语义混淆。

### 2.1 编排层（Orchestrator，平台负责）

职责：

- 生命周期与状态机推进（TODO / RUNNING / REVIEW / DONE 等）。
- 并发调度、超时、取消、重试、资源隔离（worktree/端口/data）。
- 审计与安全策略（日志留存、权限边界、强约束）。

原则：

- 编排层只定义“阶段边界与安全红线”，不定义每一步具体 Git 策略细节。

### 2.2 策略层（Strategy，Claude 主导）

职责：

- 针对单 task 生成执行计划（提交粒度、rebase 时机、测试优先级、回滚路径）。
- 在失败场景中给出恢复建议（如先 fix test 还是先拆 commit）。
- 输出结构化“策略决策记录”，供平台执行或校验。

原则：

- 策略可变、可学习；但必须可解释、可审计（有决策理由与置信度）。

### 2.3 执行层（Executor，平台执行 + Claude 协作）

职责：

- 按策略层输出执行命令与校验。
- 发生违规或高风险动作时触发 guardrail（拒绝、降级或人工确认）。
- 写回事件流（策略、执行、结果、错误归因）。

原则：

- 执行层是“策略到命令”的可控翻译器，而非硬编码一条永远不变的流水线。

## 3. 口径修正：从“固定流水线”到“可配置策略模板”

建议将当前 `worktree -> claude -> commit -> rebase -> test -> push -> PR` 由“唯一标准路径”改为：

- **默认模板 A（稳健）**：适合主分支保护严格的仓库。
- **默认模板 B（快速）**：减少中间步骤，强调迭代速度。
- **默认模板 C（修复）**：针对 failed/retry 场景优先恢复。

每个模板仅规定关键门禁，不钉死中间动作顺序，具体顺序由 Claude 策略层在模板约束内决策。

## 4. 最小可落地改造（两周）

### 阶段 1：语义对齐（文档 + UI）

1. README 与流程文档新增“分层职责图”，明确：
   - 平台负责边界与兜底。
   - Claude 负责任务策略。
2. 看板任务详情新增“本次策略卡片”：
   - 模板类型
   - 关键决策（例如“先测后 rebase”）
   - 决策原因

验收标准：

- 用户能在界面上看到“为什么这么执行”，不是只看到日志。

### 阶段 2：策略接口化（后端）

1. 在 Runner 前增加 `strategy_plan` 步骤：
   - 输入：task、repo 状态、历史失败信息。
   - 输出：结构化 JSON（步骤、前置条件、失败回退）。
2. Git 流水线执行器改为读取策略 JSON，而非写死动作顺序。
3. 增加策略校验器：
   - 必需步骤（如必须有测试或豁免理由）。
   - 风险动作白名单（force push 等默认拒绝）。

验收标准：

- 至少支持 2 种不同策略路径且都能完整审计。

### 阶段 3：灰度与回滚

1. 增加 feature flag：
   - `strategy_mode=fixed|hybrid|agentic`
2. 默认 `hybrid`：关键门禁固定，中间步骤由策略决策。
3. 一键回滚到 `fixed`，确保线上稳定性。

验收标准：

- 任意时刻可在不改代码的情况下切回 fixed。

## 5. 事件与可观测性补充

新增事件类型建议：

- `strategy_generated`
- `strategy_validated`
- `strategy_rejected`
- `strategy_fallback_applied`
- `failure_attribution`（模型决策 / 执行异常 / 环境问题）

核心指标：

- 策略采纳率（生成后被执行的比例）
- 策略回退率（被拒绝并回到 fixed 的比例）
- 首次通过率（一次完成 REVIEW 的比例）
- 平均恢复时长（FAILED 到可重试 READY）

## 6. 风险与防线

风险：

- 策略自由度上升带来不稳定。
- 复杂仓库中策略质量不足导致波动。

防线：

- 模板约束 + 校验器双保险。
- 高风险动作 guardrail。
- 可回滚 fixed 模式。
- 对失败原因做强归因，持续优化策略 prompt。

## 7. 对外话术建议

建议统一说法：

> 系统由平台负责“安全编排与审计”，由 Claude 负责“任务策略与代码执行”。
> 这是一种“受约束的 Claude 驱动”，而不是完全放权或完全写死。

这样既保留“Claude 驱动”价值，也不掩盖工程化护栏。

## 8. 本方案带来的直接收益

- 认知一致：设计、实现、对外描述统一。
- 迭代更快：策略层可快速试验，不必频繁改底层编排代码。
- 可运营：有指标可评估 Claude 决策质量与收益。
- 可托底：出现波动可立即回退固定流程。
